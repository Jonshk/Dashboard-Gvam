<form
  class="d-flex flex-column gap-3"
  [formGroup]="policyForm"
  (ngSubmit)="onSubmit()"
>
  <label>
    Nombre de la política
    <input
      type="text"
      class="form-control"
      name="name"
      name="name"
      formControlName="name"
    />
    @if (policyName?.invalid && (policyName?.dirty || policyName?.touched)) {
      @if (policyName?.hasError("required")) {
        <small class="text-danger">El nombre es obligatorio</small>
      }
      @if (policyName?.hasError("pattern")) {
        <small class="text-danger"
          >El nombre ha de ser alfanumérico y no puede contener espacios en
          blanco</small
        >
      }
    }
  </label>

  <label class="form-check-label">
    Establecer como política por defecto del grupo
    <input
      type="checkbox"
      class="form-check-input"
      name="isDefault"
      formControlName="isDefault"
    />
  </label>

  <div
    class="d-flex flex-column"
    name="applicationPolicies"
    formArrayName="applicationPolicies"
  >
    Politica de aplicaciones
    <button
      type="button"
      class="btn btn-outline-primary my-2"
      (click)="addApplicationPolicy()"
    >
      Añadir aplicación
    </button>
    @for (
      application of applicationPolicy.controls;
      track application.value;
      let i = $index
    ) {
      <div class="d-flex flex-column gap-3" [formGroupName]="i">
        <label>
          Paquete de la aplicación
          <input
            type="text"
            class="form-control"
            name="packageName"
            formControlName="packageName"
          />

          @if (application.get("packageName")?.invalid) {
            @if (application.get("packageName")?.hasError("required")) {
              <small class="text-danger"
                >El nombre del paquete es obligatorio</small
              >
            }
          }
        </label>

        <label>
          Tipo de instalación
          <select
            class="form-select"
            name="installType"
            formControlName="installType"
          >
            @for (installType of installTypeKeys; track installType) {
              <option [value]="InstallType[installType]">
                {{ installType }}
              </option>
            }
          </select>
        </label>

        <label>
          Política de permisos
          <select
            class="form-select"
            name="defaultPermissionPolicy"
            formControlName="defaultPermissionPolicy"
          >
            @for (
              permissionPolicy of permissionPolicyKeys;
              track permissionPolicy
            ) {
              <option [value]="PermissionPolicy[permissionPolicy]">
                {{ permissionPolicy }}
              </option>
            }
          </select>
        </label>

        <label class="form-check-label">
          Deshabilitada
          <input
            type="checkbox"
            class="form-check-input"
            name="disabled"
            formControlName="disabled"
          />
        </label>

        <label>
          Modo de autoactualización
          <select
            class="form-select"
            name="autoUpdateMode"
            formControlName="autoUpdateMode"
          >
            @for (autoUpdateMode of autoUpdateModeKeys; track autoUpdateMode) {
              <option [value]="AutoUpdateMode[autoUpdateMode]">
                {{ autoUpdateMode }}
              </option>
            }
          </select>
        </label>

        <button
          type="button"
          class="btn btn-outline-danger my-2"
          (click)="removeApplicationPolicy(i)"
        >
          Eliminar aplicación
        </button>
      </div>
    }
  </div>
  <label>
    Estado del Wifi
    <select class="form-select" name="wifiState" formControlName="wifiState">
      @for (wifiState of wifiStateKeys; track wifiState) {
        <option [value]="WifiState[wifiState]">
          {{ wifiState }}
        </option>
      }
    </select>
  </label>

  <div
    class="d-flex flex-column gap-3"
    name="wifiSsidPolicy"
    formGroupName="wifiSsidPolicy"
  >
    Política de SSID
    <label
      >Tipo de política
      <select
        class="form-select"
        name="wifiSsidPolicyType"
        formControlName="wifiSsidPolicyType"
      >
        @for (
          wifiSsidPolicyType of wifiSsidPolicyTypeKeys;
          track wifiSsidPolicyType
        ) {
          <option [value]="WifiSsidPolicyType[wifiSsidPolicyType]">
            {{ wifiSsidPolicyType }}
          </option>
        }
      </select>
    </label>
    <label formArrayName="wifiSsids">
      SSID
      <button
        type="button"
        class="btn btn-outline-primary btn-sm"
        (click)="addWifiSsid()"
      >
        Añadir SSID
      </button>
      <div class="d-flex flex-column gap-2">
        @for (ssid of wifiSsids.controls; track ssid; let j = $index) {
          <div class="d-flex flex-column">
            <div class="d-flex align-items-center gap-2">
              <input
                type="text"
                class="form-control form-control-sm col"
                [name]="'ssid' + j"
                [formControlName]="j"
              />
              <button
                type="button"
                class="btn btn-outline-danger btn-sm col"
                (click)="removeWifiSsid(j)"
              >
                Eliminar SSID
              </button>
            </div>
            @if (ssid?.invalid) {
              @if (ssid?.hasError("required")) {
                <small class="text-danger">El SSID es obligatorio</small>
              }
            }
          </div>
        }
      </div>
    </label>
  </div>

  <label>
    Modo de localización
    <select
      class="form-select"
      name="locationMode"
      formControlName="locationMode"
    >
      @for (locationMode of locationModeKeys; track locationMode) {
        <option [value]="LocationMode[locationMode]">
          {{ locationMode }}
        </option>
      }
    </select>
  </label>

  <label class="form-check-label">
    Bluetooth deshabilitado
    <input
      type="checkbox"
      class="form-check-input"
      name="bluetoothDisabled"
      formControlName="bluetoothDisabled"
    />
  </label>

  <label class="form-check-label">
    Ajustar volumen deshabilitado
    <input
      type="checkbox"
      class="form-check-input"
      name="adjustVolumeDisabled"
      formControlName="adjustVolumeDisabled"
    />
  </label>

  <label>
    Botón de encendido
    <select
      class="form-select"
      name="powerButtonAction"
      formControlName="powerButtonAction"
    >
      @for (
        powerButtonAction of powerButtonActionKeys;
        track powerButtonAction
      ) {
        <option [value]="PowerButtonAction[powerButtonAction]">
          {{ powerButtonAction }}
        </option>
      }
    </select>
  </label>

  <label>
    Acceso de datos USB
    <select
      class="form-select"
      name="usbDataAccess"
      formControlName="usbDataAccess"
    >
      @for (usbDataAccess of usbDataAccesKeys; track usbDataAccess) {
        <option [value]="UsbDataAccess[usbDataAccess]">
          {{ usbDataAccess }}
        </option>
      }
    </select>
  </label>

  <label class="form-check-label">
    Restablecimiento a fábrica deshabilitado
    <input
      type="checkbox"
      class="form-check-input"
      name="factoryResetDisabled"
      formControlName="factoryResetDisabled"
    />
  </label>

  <label class="form-check-label">
    Instalación de aplicaciones deshabilitado
    <input
      type="checkbox"
      class="form-check-input"
      name="installAppsDisabled"
      formControlName="installAppsDisabled"
    />
  </label>

  <button
    type="submit"
    class="btn btn-primary mt-2"
    [disabled]="policyForm.invalid || loadingService.isLoading()"
  >
    @if (editPolicy()) {
      Editar política
    } @else {
      Crear política
    }
  </button>
</form>
